---
- name: install python
  raw: sh -c "ASSUME_ALWAYS_YES=yes pkg install python3"

- setup:

- name: install bootstrap packages
  pkgng:
    name:
      - ca_root_nss
      - fish
      - sudo
      - openmdns

- name: configure openmdns
  command: "sysrc mdnsd_flags=\"{{ ansible_interfaces | difference(['lo0']) | join(' ') }}\""
  changed_when: false

- name: start openmdns
  service:
    name: mdnsd
    enabled: true
    state: started

- name: give sudo to wheel group
  lineinfile:
    path: /usr/local/etc/sudoers
    line: "%wheel ALL=(ALL) NOPASSWD: ALL"
    validate: "visudo -cf %s"

- name: create a user
  user:
    name: "{{ username | default(lookup('env', 'USER')) }}"
    comment: "{{ full_name }}"
    groups: wheel
    shell: "{{ shell }}"
    state: present
    generate_ssh_key: "{{ key_name is undefined }}"
  register: user

- name: make .ssh directory for the user
  file:
    path: "{{ user.home }}/.ssh"
    state: directory
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: '700'

- name: copy up local ssh key
  copy:
    src: "{{ lookup('env', 'HOME') }}/.ssh/{{ item.name }}"
    dest: "{{ user.home }}/.ssh"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "{{ item.mode }}"
  loop:
    - name: "{{ key_name }}"
      mode: "600"
    - name: "{{ key_name }}.pub"
      mode: "644"
  when: key_name is defined

- name: populate authorized_keys
  authorized_key:
    user: "{{ item }}"
    key: "https://github.com/{{ github_user }}.keys"
    state: present
  loop:
    - root
    - "{{ user.name }}"
  when: github_user is defined
